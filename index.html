<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Booking Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better UI feedback and transitions */
        .slot-btn {
            transition: all 0.2s ease-in-out;
        }
        .slot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .admin-panel {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Modal backdrop */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Booking Schedule</h1>
            <p class="text-gray-600 mt-2">Admin can set available times. Everyone sees the status in real-time.</p>
        </header>

        <!-- Admin Panel -->
        <div class="bg-white p-6 rounded-2xl mb-8 admin-panel border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Admin Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="scheduleDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="scheduleDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                    <input type="time" id="startTime" step="900" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                    <input type="time" id="endTime" step="900" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="mt-4">
                <button id="generateSlotsBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-indigo-400">
                    Generate & Save Slots
                </button>
            </div>
        </div>

        <!-- Public Viewing Area -->
        <div>
            <h2 class="text-2xl font-semibold mb-4 text-center text-gray-800">Available Slots for <span id="displayDate" class="text-indigo-600">Today</span></h2>
             <div id="loading" class="text-center text-gray-500 py-4">Loading slots...</div>
            <div id="publicSlotsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Slots will be dynamically inserted here -->
            </div>
             <div id="noSlotsMessage" class="hidden text-center bg-gray-100 p-6 rounded-lg">
                <p class="text-gray-600">No slots have been set for this date yet. Select a date and use the admin panel to generate them.</p>
            </div>
        </div>
        
        <!-- User ID Display -->
        <div class="text-center mt-8 p-4 bg-gray-100 rounded-lg">
            <p class="text-sm text-gray-600">Your User ID (for collaboration):</p>
            <p id="userId" class="text-md font-mono bg-white p-2 rounded-md inline-block mt-1 shadow-sm">Authenticating...</p>
        </div>

    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 modal-backdrop">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 id="alertTitle" class="text-lg leading-6 font-medium text-gray-900">Notification</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="alertMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeAlertBtn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 modal-backdrop">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white">
            <div class="text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Admin Action Required</h3>
                <p class="text-sm text-gray-500 mt-2">Enter admin password to proceed.</p>
                <div class="mt-4">
                    <input type="password" id="passwordInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Password is 'admin'">
                    <p id="passwordError" class="text-red-500 text-xs mt-2 hidden">Incorrect password. Please try again.</p>
                </div>
                <div class="flex items-center justify-end gap-3 mt-6">
                    <button id="cancelPasswordBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                        Cancel
                    </button>
                    <button id="submitPasswordBtn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-booking-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUserId = null;
        let currentScheduleDate = new Date().toISOString().slice(0, 10); // Default to today
        let slotsUnsubscribe = null; // To store the Firestore listener cleanup function
        let pendingAdminAction = null; // To hold the function that needs admin rights

        // --- DOM Elements ---
        const scheduleDateInput = document.getElementById('scheduleDate');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const generateSlotsBtn = document.getElementById('generateSlotsBtn');
        const publicSlotsContainer = document.getElementById('publicSlotsContainer');
        const displayDateElem = document.getElementById('displayDate');
        const noSlotsMessage = document.getElementById('noSlotsMessage');
        const loadingDiv = document.getElementById('loading');
        const userIdElem = document.getElementById('userId');
        
        // Modal Elements
        const customAlert = document.getElementById('customAlert');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const closeAlertBtn = document.getElementById('closeAlertBtn');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');

        // --- UI Logic ---

        /**
         * Shows a custom alert modal with a title and message.
         * @param {string} message The main text of the alert.
         * @param {string} [title='Notification'] The title of the alert modal.
         */
        function showAlert(message, title = 'Notification') {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            customAlert.classList.remove('hidden');
        }

        /**
         * Requests admin password by showing a modal. If password is correct,
         * it executes the `action` callback.
         * @param {Function} action The function to execute on successful password entry.
         */
        function requestAdminPassword(action) {
            pendingAdminAction = action; // Store the action to run later
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        /**
         * Renders the booking slots in the UI.
         * @param {Array<Object>} slots Array of slot objects from Firestore.
         */
        function renderSlots(slots) {
            publicSlotsContainer.innerHTML = '';
            if (!slots || slots.length === 0) {
                 noSlotsMessage.classList.remove('hidden');
                 return;
            }
            noSlotsMessage.classList.add('hidden');

            slots.forEach((slot, index) => {
                const slotEl = document.createElement('button');
                slotEl.textContent = slot.time;
                slotEl.dataset.index = index;
                slotEl.classList.add('p-3', 'rounded-lg', 'text-center', 'font-semibold', 'slot-btn', 'border');
                
                if (slot.status === 'booked') {
                    slotEl.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600', 'border-red-600', 'cursor-pointer');
                    slotEl.title = `Booked by ${slot.bookedBy || 'Admin'}. Click to make available.`;
                } else { // 'available'
                    slotEl.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600', 'border-green-600', 'cursor-pointer');
                    slotEl.title = 'Click to book this slot.';
                }
                
                slotEl.addEventListener('click', () => {
                    requestAdminPassword(() => handleSlotClick(index, slots));
                });
                publicSlotsContainer.appendChild(slotEl);
            });
        }

        // --- Core Application Logic ---
        
        /**
         * Attaches a real-time listener to Firestore for the given date's schedule.
         * It automatically cleans up the previous listener.
         * @param {string} dateString - The date to listen to in YYYY-MM-DD format.
         */
        function listenForScheduleChanges(dateString) {
            if (slotsUnsubscribe) slotsUnsubscribe(); // Detach the old listener to prevent memory leaks
            
            currentScheduleDate = dateString;
            const displayDate = new Date(dateString + 'T00:00:00'); // Use T00:00:00 to avoid timezone issues
            displayDateElem.textContent = displayDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Reset UI for the new date
            loadingDiv.style.display = 'block';
            publicSlotsContainer.innerHTML = '';
            noSlotsMessage.classList.add('hidden');
            
            const docRef = doc(db, "artifacts", appId, "public/data/slots", dateString);

            slotsUnsubscribe = onSnapshot(docRef, (docSnap) => {
                loadingDiv.style.display = 'none';
                if (docSnap.exists() && docSnap.data().slots) {
                    renderSlots(docSnap.data().slots);
                } else {
                    // Document doesn't exist or has no slots array
                    renderSlots([]); // This will show the 'no slots' message
                }
            }, (error) => {
                console.error("Error with Firestore listener:", error);
                loadingDiv.textContent = 'Error loading slots.';
                showAlert("Could not fetch schedule data. Please check the console for errors.", "Error");
            });
        }
        
        /**
         * Handles the logic for a user clicking on a slot to change its status.
         * This function is intended to be called after admin password verification.
         * @param {number} index The index of the clicked slot in the array.
         * @param {Array<Object>} currentSlots The current array of slots.
         */
        async function handleSlotClick(index, currentSlots) {
            if (!currentUserId) return showAlert("You must be authenticated to perform this action.");

            // Create a deep copy to avoid mutating the original array
            const newSlots = JSON.parse(JSON.stringify(currentSlots));
            const clickedSlot = newSlots[index];

            // Toggle the status
            if (clickedSlot.status === 'available') {
                clickedSlot.status = 'booked';
                clickedSlot.bookedBy = currentUserId; // Track who booked it
            } else {
                clickedSlot.status = 'available';
                delete clickedSlot.bookedBy; // Remove booking info
            }

            try {
                const docRef = doc(db, "artifacts", appId, "public/data/slots", currentScheduleDate);
                await updateDoc(docRef, { slots: newSlots });
                // The UI will update automatically via the onSnapshot listener
            } catch (error) {
                console.error("Error updating slot status: ", error);
                showAlert("Failed to update the slot. Please check the console for details.", "Error");
            }
        }

        /**
         * Generates time slots based on admin input and saves them to Firestore.
         * This function is intended to be called after admin password verification.
         */
        async function generateAndSaveSlots() {
            const date = scheduleDateInput.value;
            const start = startTimeInput.value;
            const end = endTimeInput.value;

            if (!date || !start || !end) return showAlert("Please select a valid date, start time, and end time.", "Input Error");
            if (start >= end) return showAlert("Start time must be before the end time.", "Input Error");

            // Switch the view to the new date if it's different
            if (date !== currentScheduleDate) {
                listenForScheduleChanges(date);
            }

            const slots = [];
            let currentTime = new Date(`${date}T${start}`);
            const endTime = new Date(`${date}T${end}`);
            
            generateSlotsBtn.disabled = true;
            generateSlotsBtn.textContent = 'Generating...';

            while (currentTime < endTime) {
                // More reliable way to format time as HH:MM
                const hours = String(currentTime.getHours()).padStart(2, '0');
                const minutes = String(currentTime.getMinutes()).padStart(2, '0');
                slots.push({
                    time: `${hours}:${minutes}`,
                    status: 'available'
                });
                currentTime.setMinutes(currentTime.getMinutes() + 15); // Increment by 15 minutes
            }

            try {
                const docRef = doc(db, "artifacts", appId, "public/data/slots", date);
                await setDoc(docRef, { slots: slots });
                showAlert(`Successfully generated ${slots.length} slots for ${date}!`, "Success");
            } catch (error) {
                console.error("Error writing document: ", error);
                showAlert("Failed to save the new schedule. Please check the console for details.", "Error");
            } finally {
                generateSlotsBtn.disabled = false;
                generateSlotsBtn.textContent = 'Generate & Save Slots';
            }
        }
        
        // --- Initial Setup ---

        /**
         * Sets up Firebase authentication and listens for user state changes.
         */
        async function setupAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userIdElem.textContent = 'Auth Error!';
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdElem.textContent = currentUserId;
                    // Initial data load after authentication is confirmed
                    listenForScheduleChanges(currentScheduleDate); 
                } else {
                    currentUserId = null;
                    userIdElem.textContent = 'Not authenticated';
                    publicSlotsContainer.innerHTML = '<p class="text-center col-span-full">Please authenticate to see the schedule.</p>';
                }
            });
        }

        /**
         * Sets up all initial event listeners for the application.
         */
        function setupEventListeners() {
            // Admin panel listeners
            generateSlotsBtn.addEventListener('click', () => {
                requestAdminPassword(generateAndSaveSlots);
            });
            scheduleDateInput.addEventListener('change', (e) => listenForScheduleChanges(e.target.value));

            // Modal listeners
            closeAlertBtn.addEventListener('click', () => customAlert.classList.add('hidden'));
            cancelPasswordBtn.addEventListener('click', () => {
                passwordModal.classList.add('hidden');
                pendingAdminAction = null; // Clear pending action on cancel
            });
            submitPasswordBtn.addEventListener('click', () => {
                if (passwordInput.value === 'admin') {
                    passwordModal.classList.add('hidden');
                    if (typeof pendingAdminAction === 'function') {
                        pendingAdminAction(); // Execute the stored action
                    }
                    pendingAdminAction = null; // Reset for next time
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
        }

        /**
         * Initializes the application.
         */
        function setupApplication() {
            // Set default values for the admin form
            scheduleDateInput.value = currentScheduleDate;
            startTimeInput.value = "09:00";
            endTimeInput.value = "17:00";
            
            setupEventListeners();
            setupAuth();
        }

        // Run the app once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', setupApplication);

    </script>
</body>
</html>
